<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Transaksi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Tahoma', sans-serif; padding: 20px; }
    .container { margin-top: 30px; }
    .table-container { box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); border-radius: 10px; background-color: white; padding: 20px; }
    h1 { text-align: center; margin-bottom: 30px; }
    .table thead th { background-color: #343a40; color: white; }
    .form-container { box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); border-radius: 10px; background-color: white; padding: 20px; margin-top: 20px; display: none; }
    .badge-status { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-pending { background-color: #ffc107; color: #000; }
    .status-selesai { background-color: #28a745; color: white; }
  </style>
</head>
<body>
  <div class="form-container" id="formContainer">
    <h3 id="formTitle">Tambah Transaksi Baru</h3>
    <form id="addTransaksiForm">
      <div class="mb-3">
        <label for="tanggalTransaksi" class="form-label">Tanggal Transaksi</label>
        <input type="date" class="form-control" id="tanggalTransaksi" readonly style="background-color: #e9ecef;" required>
        <!--<small class="text-muted">Tanggal otomatis sesuai hari ini</small>-->
      </div>
      <div class="mb-3">
        <label for="idProduk" class="form-label">Produk</label>
        <select class="form-control" id="idProduk" required>
          <option value="">Pilih Produk</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="namaProduk" class="form-label">Nama Produk</label>
        <input type="text" class="form-control" id="namaProduk" readonly>
      </div>
      <div class="mb-3">
        <label for="hargaSatuan" class="form-label">Harga Satuan</label>
        <input type="text" class="form-control" id="hargaSatuan" readonly>
      </div>
      <div class="mb-3">
        <label for="jumlah" class="form-label">Jumlah</label>
        <input type="number" class="form-control" id="jumlah" min="1" required>
      <!--<small class="text-muted">Stok akan dicek otomatis</small>-->
      </div>
      <div class="mb-3">
        <label for="totalHarga" class="form-label">Total Harga</label>
        <input type="text" class="form-control" id="totalHarga" readonly>
      </div>
      <button type="submit" class="btn btn-success" id="submitBtn">Submit</button>
      <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
    </form>
  </div>

  <div class="container">
    <div class="table-container">
      <h1>Daftar Transaksi - P7_018</h1>
      <button id="addTransactionBtn" class="btn btn-primary mb-3">+ Add Data</button>
      <table id="transaction-table" class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tanggal</th>
            <th>Produk</th>
            <th>Jumlah</th>
            <th>Total Harga</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="text-center">Memuat data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const readUrl = 'https://api.roniprsty.com/transaksi/read.php';
    const createUrl = 'https://api.roniprsty.com/transaksi/create.php';
    const updateUrl = 'https://api.roniprsty.com/transaksi/update.php';
    const produkReadUrl = 'https://api.roniprsty.com/produk/list_aktif.php';

    let produkList = [];
    let transaksiList = [];
    let hargaSatuanValue = 0;
    let totalHargaValue = 0;

    // Fungsi untuk mengambil data produk
    async function getProducts() {
      try {
        let response = await fetch(produkReadUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        produkList = await response.json();
        
        let selectProduk = document.getElementById('idProduk');
        selectProduk.innerHTML = '<option value="">Pilih Produk</option>';
        
        produkList.forEach(produk => {
          let option = document.createElement('option');
          option.value = produk.id;
          option.textContent = `${produk.nama_produk} (Stok: ${produk.stok}, Harga: Rp${parseFloat(produk.harga_jual).toLocaleString('id-ID')})`;
          option.dataset.nama = produk.nama_produk;
          option.dataset.harga = produk.harga_jual;
          option.dataset.stok = produk.stok;
          selectProduk.appendChild(option);
        });
      } catch (error) {
        console.error("Gagal mengambil data produk:", error);
      }
    }

    // Event listener untuk perubahan produk
    document.getElementById('idProduk').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value) {
        document.getElementById('namaProduk').value = selectedOption.dataset.nama;
        hargaSatuanValue = parseFloat(selectedOption.dataset.harga);
        document.getElementById('hargaSatuan').value = 'Rp ' + hargaSatuanValue.toLocaleString('id-ID');
        document.getElementById('jumlah').max = selectedOption.dataset.stok;
        hitungTotal();
      } else {
        document.getElementById('namaProduk').value = '';
        document.getElementById('hargaSatuan').value = '';
        document.getElementById('totalHarga').value = '';
        document.getElementById('jumlah').max = '';
        hargaSatuanValue = 0;
        totalHargaValue = 0;
      }
    });

    // Event listener untuk perubahan jumlah
    document.getElementById('jumlah').addEventListener('input', hitungTotal);

    // Fungsi untuk menghitung total harga
    function hitungTotal() {
      const jumlah = parseInt(document.getElementById('jumlah').value) || 0;
      const selectedOption = document.getElementById('idProduk').options[document.getElementById('idProduk').selectedIndex];
      const stok = parseInt(selectedOption.dataset.stok) || 0;

      if (jumlah > stok) {
        Swal.fire({ icon: 'warning', title: 'Stok Tidak Cukup!', text: `Stok hanya tersedia ${stok} item`, timer: 2000 });
        document.getElementById('jumlah').value = stok;
        totalHargaValue = hargaSatuanValue * stok;
      } else {
        totalHargaValue = hargaSatuanValue * jumlah;
      }
      document.getElementById('totalHarga').value = 'Rp ' + totalHargaValue.toLocaleString('id-ID');
    }

    // Fungsi untuk mengambil data transaksi
    async function getTransactions() {
      try {
        let response = await fetch(readUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        transaksiList = await response.json();
        
        let tableBody = document.querySelector('#transaction-table tbody');
        tableBody.innerHTML = '';

        transaksiList.forEach(transaction => {
          const statusClass = transaction.status_transaksi === 'Pending' ? 'status-pending' : 'status-selesai';
          const aksiBtn = transaction.status_transaksi === 'Pending' 
            ? `<button class="btn btn-warning btn-sm" onclick="editTransaksi('${transaction.id_transaksi}')">Edit</button>`
            : `<span class="text-muted">-</span>`;
          
          let row = `
            <tr>
              <td>${transaction.id_transaksi}</td>
              <td>${transaction.tanggal_transaksi}</td>
              <td>${transaction.nama_produk}</td>
              <td>${transaction.jumlah}</td>
              <td>Rp${parseFloat(transaction.total_harga).toLocaleString('id-ID')}</td>
              <td><span class="badge-status ${statusClass}">${transaction.status_transaksi}</span></td>
              <td>${aksiBtn}</td>
            </tr>
          `;
          tableBody.innerHTML += row;
        });
      } catch (error) {
        console.error("Gagal mengambil data transaksi:", error);
        document.querySelector('#transaction-table tbody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Gagal memuat data</td></tr>';
      }
    }

    // Tampilkan form untuk menambahkan transaksi baru
    document.getElementById('addTransactionBtn').addEventListener('click', function() {
      document.getElementById('formTitle').textContent = 'Tambah Transaksi Baru';
      document.getElementById('submitBtn').textContent = 'Submit';
      document.getElementById('addTransaksiForm').reset();
      document.getElementById('formContainer').style.display = 'block';
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('tanggalTransaksi').value = today;
      
      document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Sembunyikan form saat tombol Cancel diklik
    document.getElementById('cancelBtn').addEventListener('click', function() {
      document.getElementById('formContainer').style.display = 'none';
    });

    // Handle form submission
    document.getElementById('addTransaksiForm').addEventListener('submit', async function(event) {
      event.preventDefault();

      const transactionData = {
        "tanggal_transaksi": document.getElementById('tanggalTransaksi').value,
        "id_produk": document.getElementById('idProduk').value,
        "nama_produk": document.getElementById('namaProduk').value,
        "jumlah": document.getElementById('jumlah').value,
        "total_harga": totalHargaValue,
        "status_transaksi": "Pending"
      };

      try {
        let response = await fetch(createUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(transactionData)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Transaksi berhasil ditambahkan', timer: 2000, showConfirmButton: false });
        
        setTimeout(() => {
          getTransactions();
          getProducts();
          document.getElementById('formContainer').style.display = 'none';
          document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 500);
      } catch (error) {
        console.error("Gagal mengirim data transaksi:", error);
        Swal.fire({ icon: 'error', title: 'Gagal!', text: 'Gagal menambahkan transaksi' });
      }
    });

    // Fungsi untuk edit transaksi (ubah status dari Pending ke Selesai)
    async function editTransaksi(id) {
      Swal.fire({
        title: 'Konfirmasi Edit',
        html: `
          <div style="text-align: left; padding: 10px;">
            <p><strong>ID Transaksi:</strong> ${id}</p>
            <hr>
            <p><strong>Status Saat Ini:</strong> <span style="color: #856404;">Pending</span></p>
            <p><strong>Status Baru:</strong> <span style="color: #155724;">Selesai</span></p>
            <hr>
            <p style="color: #6c757d; font-size: 14px;">
              ⚠️ Status tidak dapat diubah kembali setelah diselesaikan.
            </p>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, Ubah',
        cancelButtonText: 'Batal'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const transactionData = { id_transaksi: id, status_transaksi: "Selesai" };
            
            let response = await fetch(updateUrl, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(transactionData)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            Swal.fire({
              icon: 'success',
              title: 'Berhasil!',
              text: 'Status transaksi berhasil diperbarui',
              timer: 2000,
              showConfirmButton: false
            });
            
            setTimeout(() => {
              getTransactions();
              getProducts();
            }, 500);
          } catch (error) {
            console.error("Gagal mengupdate transaksi:", error);
            Swal.fire({
              icon: 'error',
              title: 'Gagal!',
              text: 'Terjadi kesalahan saat mengupdate transaksi'
            });
          }
        }
      });
    }

    // Inisialisasi halaman
    getProducts();
    getTransactions();
  </script>
</body>
</html>